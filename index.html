
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<meta name="theme-color" content="#0b0f15">
<title>Forklift Runner</title>
<style>
  :root { color-scheme: dark; --bg:#0b0f15; --panel:#121826; --accent:#00d084; --muted:#7a8aa0; --warn:#ffb020; --danger:#ff4d4f; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;gap:.5rem}
  header,footer{display:flex;align-items:center;justify-content:space-between;padding:.6rem .9rem;background:linear-gradient(180deg,#111827,#0e1522);box-shadow:0 6px 24px rgba(0,0,0,.35);z-index:3}
  header h1{margin:0;font-size:1rem;font-weight:700;letter-spacing:.4px;color:#e6edf7}
  header .right{display:flex;gap:.4rem;align-items:center}
  .pill{background:#0f1729;border:1px solid #1f2a44;color:#c8d5ea;padding:.35rem .6rem;border-radius:999px;font-size:.8rem}
  .btn{appearance:none;border:1px solid #22304d;background:#0f1729;color:#e6edf7;padding:.5rem .75rem;border-radius:.7rem;font-weight:600;cursor:pointer}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  #hud{position:fixed;left:0;right:0;top:52px;display:flex;justify-content:center;pointer-events:none;z-index:3}
  #hud .card{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;justify-content:center;padding:.45rem .8rem;background:#0f1729cc;border:1px solid #1e293b;border-radius:.8rem;backdrop-filter:blur(6px);color:#e6edf7;font-weight:600}
  #hud .kv{display:flex;gap:.35rem;align-items:baseline}
  #hud .kv .k{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
  #hud .kv .v{font-variant-numeric:tabular-nums}
  #hud .power{display:flex;gap:.4rem}
  .chip{border:1px solid #1f2a44;background:#0f1729;padding:.2rem .5rem;border-radius:.6rem;font-size:.78rem}
  canvas{display:block;position:absolute;inset:0}
  #controls{position:fixed;inset:auto 0 0 0;display:grid;grid-template-columns:1fr auto 1fr;gap:.75rem;padding:.75rem;z-index:4;touch-action:none}
  .pad{display:grid;grid-template-columns:repeat(3,64px);grid-template-rows:repeat(3,64px);gap:.5rem;place-content:center}
  .key{width:64px;height:64px;border-radius:18px;background:#111a2d;border:1px solid #1f2a44;color:#cfe3ff;display:flex;align-items:center;justify-content:center;font-weight:700;user-select:none}
  .key.active{outline:2px solid var(--accent);color:#fff}
  .rightcol{display:flex;flex-direction:column;gap:.5rem;align-items:flex-end;justify-content:center}
  .key.wide{width:128px}
  @media(min-width:980px){ #controls{display:none} }
  .toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:.8rem 1rem;background:#0f1729e6;border:1px solid #22304d;color:#e6edf7;border-radius:.8rem;z-index:5;display:none}
  .toast.show{display:block}
  /* modal */
  .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:6}
  .modal .panel{background:#0f1729;border:1px solid #22304d;border-radius:14px;min-width:min(560px,92vw);max-width:92vw;padding:1rem}
  .panel h2{margin:.2rem 0 .6rem 0;color:#e6edf7}
  .grid{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .scores{margin:.5rem 0;padding:.6rem;border:1px solid #1f2a44;border-radius:10px;background:#0b1222}
  .scores ol{margin:.3rem 0 .1rem 0;padding-left:1.2rem}
  .tip{color:#7a8aa0;font-size:.9rem}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Forklift Runner</h1>
    <div class="right">
      <div class="pill" id="bestPill">Best: 00:00 | 0</div>
      <button class="btn" id="resetBtn" title="Reset (R)">Reset</button>
      <button class="btn" id="pauseBtn" title="Pause (P)">Pause</button>
      <button class="btn" id="installBtn" style="display:none">Install</button>
    </div>
  </header>

  <div id="hud">
    <div class="card">
      <div class="kv"><span class="k">Time</span><span class="v" id="timeV">00:00</span></div>
      <div class="kv"><span class="k">Score</span><span class="v" id="scoreV">0</span></div>
      <div class="kv"><span class="k">Combo</span><span class="v" id="comboV">x1</span></div>
      <div class="kv"><span class="k">Loads</span><span class="v" id="loadsV">0</span></div>
      <div class="kv"><span class="k">Speed</span><span class="v" id="speedV">0 km/h</span></div>
      <div class="power">
        <div class="chip" id="magChip">Magnet: —</div>
        <div class="chip" id="frzChip">Freeze: —</div>
        <div class="chip" id="shdChip">Shield: —</div>
      </div>
    </div>
  </div>

  <canvas id="game"></canvas>

  <footer>
    <div style="color:#7a8aa0;font-size:.85rem">Controls: ← → steer, ↑ throttle, ↓ brake, <b>Space</b> pick/drop, <b>H</b> horn (stun), <b>P</b> pause, <b>R</b> reset</div>
    <div style="display:flex;gap:.5rem">
      <button class="btn" id="muteBtn">Mute</button>
      <button class="btn" id="helpBtn">Help</button>
    </div>
  </footer>
</div>

<div class="toast" id="toast">Picked up! Deliver to the matching coloured rack →</div>

<!-- Mobile touch controls -->
<div id="controls">
  <div class="pad" id="padL">
    <div></div><div class="key" data-k="ArrowUp">▲</div><div></div>
    <div class="key" data-k="ArrowLeft">◀</div><div class="key" data-k="Space">⛏</div><div class="key" data-k="ArrowRight">▶</div>
    <div></div><div class="key" data-k="ArrowDown">▼</div><div></div>
  </div>
  <div></div>
  <div class="rightcol">
    <div class="key wide" data-k="ArrowUp">Throttle</div>
    <div class="key wide" data-k="ArrowDown">Brake</div>
    <div class="key wide" data-k="Space">Pick / Drop</div>
    <div class="key wide" data-k="KeyH">Horn</div>
  </div>
</div>

<!-- Game + PWA logic -->
<script>
(() => {
  // ----- Canvas & DPI -----
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let DPR = Math.max(1, window.devicePixelRatio || 1);
  function resize() {
    DPR = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(innerWidth * DPR);
    canvas.height = Math.floor((innerHeight) * DPR);
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
  }
  addEventListener('resize', resize, {passive:true}); resize();

  // ----- UI -----
  const $ = id => document.getElementById(id);
  const timeV = $('timeV'), scoreV = $('scoreV'), comboV = $('comboV'),
        loadsV = $('loadsV'), speedV = $('speedV'), bestPill = $('bestPill');
  const pauseBtn = $('pauseBtn'), resetBtn = $('resetBtn'), helpBtn = $('helpBtn'), toast = $('toast');
  const muteBtn = $('muteBtn');
  const magChip = $('magChip'), frzChip = $('frzChip'), shdChip = $('shdChip');

  // PWA install prompt
  let deferredPrompt = null;
  const installBtn = $('installBtn');
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
  installBtn.addEventListener('click', async () => { if (deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }});

  // Register SW (ignore errors on file:///)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }

  // ----- SFX (tiny placeholders) -----
  const SFX = {enabled:true, pick:new Audio(), drop:new Audio(), bump:new Audio(), horn:new Audio(), power:new Audio()};
  const blip = "data:audio/wav;base64,UklGRmYAAABXQVZFZm10IBIAAABAAEAQBQAAAwAAABsYWFmAAAAAAAAPwAAAP8AAP8AAAD/AP//AAD//wAA";
  SFX.pick.src=blip; SFX.drop.src=blip; SFX.bump.src=blip; SFX.horn.src=blip; SFX.power.src=blip;
  muteBtn.onclick = () => { SFX.enabled = !SFX.enabled; muteBtn.textContent = SFX.enabled ? 'Mute' : 'Unmute'; };

  function showToast(msg, ms=1100){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'), ms); }

  // ----- Input -----
  const keys = new Set(); const hold = k => keys.has(k);
  addEventListener('keydown', e => {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' ','Space','KeyP','KeyR','KeyH'].includes(e.code) || e.key === ' '){ e.preventDefault(); }
    if (e.key === ' ') keys.add('Space'); else keys.add(e.code);
  });
  addEventListener('keyup', e => { if (e.key === ' ') keys.delete('Space'); else keys.delete(e.code); });

  document.querySelectorAll('.key[data-k]').forEach(el=>{
    const k=el.dataset.k; const set=v=>{ if(v){keys.add(k); el.classList.add('active');} else {keys.delete(k); el.classList.remove('active');}};
    const start=e=>{e.preventDefault();set(true)}; const end=e=>{e.preventDefault();set(false)};
    el.addEventListener('pointerdown',start); el.addEventListener('pointerup',end);
    el.addEventListener('pointercancel',end); el.addEventListener('pointerleave',end);
  });

  // ----- World -----
  const rng=(a,b)=>a+Math.random()*(b-a); const clamp=(v,a,b)=>Math.max(a,Math.min(b,v)); const TAU=Math.PI*2;

  const COLORS = [
    {name:'Red', hue:5,  rack:'#ff6b6b'},
    {name:'Blue',hue:210,rack:'#63b3ff'},
    {name:'Green',hue:140,rack:'#34d399'},
    {name:'Yellow',hue:45,rack:'#fbbf24'},
  ];

  const world = {
    time:0, running:false, gameOver:false, startedAt:0,
    score:0, combo:1, loads:0, best:{t:0,score:0}, bgScroll:0, laneWidth: 10, speedScale:1,
    freeze:0, magnet:0, shield:0, hornCooldown:0
  };

  // Leaderboard (top 5)
  function getBoard(){ try{ return JSON.parse(localStorage.getItem('forklift_board')||'[]'); }catch{return []}}
  function setBoard(b){ try{ localStorage.setItem('forklift_board', JSON.stringify(b.slice(0,5))); }catch{} }
  function pushBoard(name, score, time){ const b=getBoard(); b.push({name,score,time,ts:Date.now()}); b.sort((a,b)=>b.score-a.score||b.time-a.time); setBoard(b); renderBoard(); }

  // Persist best
  try { const raw=localStorage.getItem('forklift_best'); if (raw) world.best = JSON.parse(raw);} catch {}
  updateBestPill();

  const player = { x:0,y:0,dir:0,w:1.2,h:2.0,vx:0,vy:0,speed:0,maxSpeed:11,accel:16,brake:24,turnRate:2.1, carrying:false,cargo:null, invulnerable:0 };

  const pallets = []; const racks = []; const obstacles = []; const powerups = [];

  function spawnInitial(){
    pallets.length=0; racks.length=0; obstacles.length=0; powerups.length=0;
    for (let i=1;i<=4;i++){
      pallets.push(spawnPallet(i*30+rng(-2,2)));
      if (i%2===0) racks.push(spawnRack(i*40+rng(-2,2)));
    }
    for (let i=0;i<16;i++) obstacles.push(spawnObstacle(rng(10,160)));
    for (let i=0;i<3;i++) powerups.push(spawnPowerUp(rng(30,140)));
  }

  function pickColor(){ return COLORS[Math.floor(Math.random()*COLORS.length)]; }
  function spawnPallet(y){
    const col = pickColor();
    return {type:'pallet', color:col, x:rng(-world.laneWidth*0.35, world.laneWidth*0.35), y, r:0.55, picked:false, hue: col.hue};
  }
  function spawnRack(y){
    const col = pickColor();
    const side = Math.random()<.5?-1:1;
    return {type:'rack', color:col, x: side*(world.laneWidth*0.5-0.6), y, w:0.9, h:3.2, delivered:false};
  }
  function spawnObstacle(y){ return {type:'cone', x:rng(-world.laneWidth*0.4,world.laneWidth*0.4), y, r:0.5, vx:rng(-.2,.2), stunned:0}; }
  function spawnPowerUp(y){
    const kinds = ['magnet','freeze','shield'];
    const k = kinds[Math.floor(Math.random()*kinds.length)];
    return {type:'power', kind:k, x:rng(-world.laneWidth*0.35,world.laneWidth*0.35), y, r:0.5};
  }

  function reset(){
    Object.assign(world,{time:0,score:0,combo:1,loads:0,bgScroll:0,speedScale:1,gameOver:false,freeze:0,magnet:0,shield:0,hornCooldown:0});
    Object.assign(player,{x:0,y:0,dir:0,vx:0,vy:0,speed:0,carrying:false,cargo:null,invulnerable:0});
    spawnInitial();
    world.running=true; world.startedAt=performance.now();
    showToast('Pick pallets, deliver to the matching coloured rack. Avoid cones!',1500);
    closeModal();
  }

  pauseBtn.onclick=()=>{ world.running=!world.running; pauseBtn.textContent = world.running?'Pause':'Resume'; if (world.running) loop(performance.now()); };
  resetBtn.onclick=()=>{ reset(); pauseBtn.textContent='Pause'; };
  helpBtn.onclick=()=>{ showToast('Hold ▲ to move, ◀ ▶ steer. SPACE pick/drop. H horn to stun cones.',1800); };

  // ----- Units / camera -----
  const metersPerPixel = ()=> (world.laneWidth * 1.6) / canvas.width;
  function toScreen(x,y){ const mpp=metersPerPixel(); const sx=canvas.width/2 + x/mpp; const sy=canvas.height*0.75 - y/mpp + world.bgScroll/mpp; return [sx,sy]; }

  // ----- Collision -----
  const circleHit=(ax,ay,ar,bx,by,br)=>{const dx=ax-bx,dy=ay-by;return (dx*dx+dy*dy)<= (ar+br)*(ar+br)};
  const aabbHit=(ax,ay,aw,ah,bx,by,bw,bh)=> Math.abs(ax-bx)<(aw+bw)/2 && Math.abs(ay-by)<(ah+bh)/2;

  // ----- Drawing -----
  function drawBackground(dt){
    const mpp = metersPerPixel();
    const slow = world.freeze>0 ? 0.35 : 0.8;
    world.bgScroll += (player.speed+.0001) * dt * slow;
    const stripeH = 2 / mpp;
    ctx.save();
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,'#0b0f15'); g.addColorStop(1,'#0f1421'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
    const startY=(world.bgScroll/mpp)%stripeH; ctx.fillStyle='#0e1728';
    for(let y=-stripeH; y<canvas.height; y+=stripeH*2){ ctx.fillRect(0,y+startY,canvas.width,stripeH); }
    const edgeX = world.laneWidth/2 / mpp; ctx.strokeStyle='#20324f'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(canvas.width/2-edgeX,0); ctx.lineTo(canvas.width/2-edgeX,canvas.height);
    ctx.moveTo(canvas.width/2+edgeX,0); ctx.lineTo(canvas.width/2+edgeX,canvas.height); ctx.stroke();
    ctx.setLineDash([14,14]); ctx.strokeStyle='#2a3e63'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(canvas.width/2,0); ctx.lineTo(canvas.width/2,canvas.height); ctx.stroke(); ctx.setLineDash([]);
    ctx.restore();
  }

  function drawForklift(){
    const [sx,sy]=toScreen(player.x,player.y); const mpp=metersPerPixel(); const w=player.w/mpp, h=player.h/mpp;
    ctx.save(); ctx.translate(sx,sy); ctx.rotate(-player.dir);
    ctx.fillStyle = player.invulnerable>0 || world.shield>0 ? '#ffd166' : '#00d084';
    roundRect(-w/2,-h/2,w,h,8); ctx.fill();
    ctx.fillStyle='#0b1020'; ctx.fillRect(-w*0.35,-h*0.55,w*0.7,h*0.15);
    ctx.fillStyle='#a1b5d8'; ctx.fillRect(-w*0.3,h*0.1,w*0.6,h*0.08); ctx.fillRect(-w*0.3,h*0.18,w*0.6,h*0.08);
    ctx.fillStyle='#0b1020'; ctx.fillRect(-w*0.45,-h*0.35,w*0.9,h*0.08); ctx.fillRect(-w*0.45,h*0.35,w*0.9,h*0.08);
    if (player.carrying && player.cargo){ ctx.save(); ctx.translate(0,h*0.05); drawPalletSprite(player.cargo.color.hue, w*0.7, h*0.25); ctx.restore(); }
    ctx.restore();
  }
  function drawPalletSprite(hue,w,h){ const base=`hsl(${hue},70%,55%)`; ctx.fillStyle=base; roundRect(-w/2,-h/2,w,h,6); ctx.fill(); ctx.strokeStyle='#00000033'; ctx.lineWidth=2; ctx.strokeRect(-w/2,-h/2,w,h); ctx.fillStyle='#1b2235'; ctx.fillRect(-w*0.05,-h/2,w*0.1,h); ctx.fillRect(-w/2,-h*0.12,w,h*0.1); ctx.fillStyle='#b08b51'; const sl=h*0.12; for(let i=-2;i<=2;i++){ ctx.fillRect(-w/2,i*sl-sl*0.5,w,sl*0.6);} }
  function drawPallet(p){ const [sx,sy]=toScreen(p.x,p.y); const mpp=metersPerPixel(); const r=p.r/mpp; ctx.save(); ctx.translate(sx,sy); drawPalletSprite(p.hue, r*2.2, r*1.6); ctx.restore(); }
  function drawRack(rk){ const [sx,sy]=toScreen(rk.x,rk.y); const mpp=metersPerPixel(); const w=rk.w/mpp, h=rk.h/mpp; ctx.save(); ctx.translate(sx,sy); ctx.fillStyle='#263858'; roundRect(-w/2,-h/2,w,h,10); ctx.fill(); ctx.strokeStyle='#3b517a'; ctx.lineWidth=3; ctx.stroke(); ctx.fillStyle=rk.color.rack; ctx.fillRect(-w*0.12,-h*0.5,w*0.24,h*0.22); ctx.restore(); }
  function drawObstacle(o){ const [sx,sy]=toScreen(o.x,o.y); const mpp=metersPerPixel(); const r=o.r/mpp; ctx.save(); ctx.translate(sx,sy); ctx.fillStyle = o.stunned>0 ? '#9ca3af' : '#ff7a00'; roundRect(-r,-r,r*2,r*2,12); ctx.fill(); ctx.fillStyle='#ffe1bf'; ctx.fillRect(-r,-r*0.2,r*2,r*0.4); ctx.restore(); }
  function drawPowerUp(p){ const [sx,sy]=toScreen(p.x,p.y); const mpp=metersPerPixel(); const r=p.r/mpp; ctx.save(); ctx.translate(sx,sy); ctx.fillStyle = p.kind==='magnet'?'#60a5fa':p.kind==='freeze'?'#22d3ee':'#f472b6'; roundRect(-r,-r,r*2,r*2,10); ctx.fill(); ctx.fillStyle='#0b1222'; ctx.font=`${Math.round(r*1.3)}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(p.kind==='magnet'?'M':p.kind==='freeze'?'F':'S',0,0); ctx.restore(); }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  // ----- Update loop -----
  let last=0;
  function loop(ts){
    if (!world.running) return;
    if (!last) last=ts;
    const dt = Math.min(0.033, (ts-last)/1000); last=ts;
    step(dt); render(dt); requestAnimationFrame(loop);
  }

  function step(dt){
    world.time += dt;
    if (world.freeze>0) world.freeze = Math.max(0, world.freeze - dt);
    if (world.magnet>0) world.magnet = Math.max(0, world.magnet - dt);
    if (world.shield>0) world.shield = Math.max(0, world.shield - dt);
    if (world.hornCooldown>0) world.hornCooldown = Math.max(0, world.hornCooldown - dt);

    const throttle=hold('ArrowUp'), brake=hold('ArrowDown'), left=hold('ArrowLeft'), right=hold('ArrowRight');
    const slow = world.freeze>0 ? 0.5 : 1;
    const targetAccel=(throttle?player.accel:0)+(brake?-player.brake:0);
    player.speed = clamp(player.speed + targetAccel*dt*slow, 0, player.maxSpeed*world.speedScale*slow);
    if (left)  player.dir += player.turnRate * dt * (1+player.speed*0.02);
    if (right) player.dir -= player.turnRate * dt * (1+player.speed*0.02);

    player.vx = Math.sin(player.dir) * player.speed;
    player.vy = Math.cos(player.dir) * player.speed;
    player.x += player.vx * dt; player.y += player.vy * dt;

    const half=world.laneWidth*0.5 - 0.6; player.x = clamp(player.x, -half, half);

    const farY = player.y + 120;
    if (pallets.length<8)   pallets.push( spawnPallet( farY + rng(10,25) ) );
    if (racks.length<6)     racks.push( spawnRack( farY + rng(20,40) ) );
    if (obstacles.length<22)obstacles.push( spawnObstacle( farY + rng(8,20) ) );
    if (powerups.length<4)  powerups.push( spawnPowerUp( farY + rng(15,35) ) );

    const cleanupY = player.y - 30;
    [pallets,racks,obstacles,powerups].forEach(arr=>{ for (let i=arr.length-1;i>=0;i--){ if (arr[i].y<cleanupY) arr.splice(i,1);} });

    // Horn (stun cones)
    if (hold('KeyH') && world.hornCooldown===0){
      SFX.enabled && SFX.horn.play().catch(()=>{});
      world.hornCooldown = 4.0;
      obstacles.forEach(o=>{ if (Math.abs(o.y-player.y)<12) o.stunned = 2.2; });
    }

    // Obstacle motion
    obstacles.forEach(o=>{
      if (o.stunned>0){ o.stunned-=dt; return; }
      const speed = world.freeze>0 ? 0.2 : 1;
      o.x += o.vx*dt*speed;
      const border=world.laneWidth*0.45;
      if (o.x<-border||o.x>border) o.vx*=-1;
    });

    // Pick / drop
    const pickPressed = hold('Space');
    if (pickPressed && !step._pickHeld){
      if (!player.carrying){
        // near pallet (magnet increases pickup radius)
        let radius = 0.9 + (world.magnet>0 ? 0.8 : 0);
        const p = pallets.find(p=>!p.picked && circleHit(player.x,player.y,radius, p.x,p.y, p.r));
        if (p){
          p.picked=true; player.carrying=true; player.cargo=p; world.combo=Math.min(world.combo+1,5);
          SFX.enabled && SFX.pick.play().catch(()=>{}); showToast(`Picked ${p.color.name}! Deliver to ${p.color.name} rack →`,1100);
        }
      } else {
        const rk = racks.find(rk=>!rk.delivered && aabbHit(player.x,player.y,1.6,2.2, rk.x,rk.y, rk.w, rk.h));
        if (rk){
          const match = rk.color.name===player.cargo.color.name;
          let gained = Math.round(60*world.combo + player.speed*2);
          if (match) gained *= 1.5; else gained = Math.round(gained*0.5);
          rk.delivered=true; player.carrying=false; player.cargo=null; world.loads++; world.score+=gained;
          SFX.enabled && SFX.drop.play().catch(()=>{}); showToast(`${match?'Perfect match':'Wrong rack'}! +${gained} (x${world.combo})`,1000);
        }
      }
      step._pickHeld=true;
    }
    if (!pickPressed) step._pickHeld=false;

    // Power-up collection
    for (let i=powerups.length-1;i>=0;i--){
      const pu=powerups[i];
      if (circleHit(player.x,player.y,1.0, pu.x,pu.y, pu.r)){
        if (pu.kind==='magnet') world.magnet=10;
        if (pu.kind==='freeze') world.freeze=6;
        if (pu.kind==='shield') world.shield=8;
        SFX.enabled && SFX.power.play().catch(()=>{});
        powerups.splice(i,1);
      }
    }

    // Collisions
    player.invulnerable = Math.max(0, player.invulnerable - dt);
    for (const o of obstacles){
      if (circleHit(player.x,player.y,0.8, o.x,o.y, o.r)){
        if (world.shield>0){ world.shield=0; player.invulnerable=1; SFX.enabled && SFX.bump.play().catch(()=>{}); continue; }
        SFX.enabled && SFX.bump.play().catch(()=>{});
        endRun(); return;
      }
    }

    // Difficulty ramp
    world.speedScale = 1 + Math.min(1.2, world.time/90);
    player.maxSpeed = 10 + world.time*0.05;

    // HUD
    timeV.textContent = fmtTime(world.time);
    scoreV.textContent = world.score.toString();
    comboV.textContent = 'x'+world.combo;
    loadsV.textContent = world.loads.toString();
    speedV.textContent = Math.round(player.speed*4).toString() + ' km/h';
    magChip.textContent = 'Magnet: ' + (world.magnet>0? (world.magnet|0)+'s':'—');
    frzChip.textContent = 'Freeze: ' + (world.freeze>0? (world.freeze|0)+'s':'—');
    shdChip.textContent = 'Shield: ' + (world.shield>0? (world.shield|0)+'s':'—');

    // Save best
    if (world.time > world.best.t || world.score > world.best.score){
      world.best = {t:world.time, score: world.score};
      try { localStorage.setItem('forklift_best', JSON.stringify(world.best)); } catch {}
      updateBestPill();
    }
  }

  function render(dt){
    drawBackground(dt);
    const all = [
      ...pallets.filter(p=>!p.picked).map(e=>({z:e.y, draw:()=>drawPallet(e)})),
      ...racks.filter(r=>!r.delivered).map(e=>({z:e.y, draw:()=>drawRack(e)})),
      ...powerups.map(e=>({z:e.y, draw:()=>drawPowerUp(e)})),
      ...obstacles.map(e=>({z:e.y, draw:()=>drawObstacle(e)})),
      {z:player.y, draw:()=>drawForklift()}
    ];
    all.sort((a,b)=>a.z-b.z); all.forEach(e=>e.draw());
  }

  function fmtTime(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return (m<10?'0':'')+m+':'+(s<10?'0':'')+s; }
  function updateBestPill(){ bestPill.textContent = `Best: ${fmtTime(world.best.t||0)} | ${world.best.score||0}`; }

  // Keyboard shortcuts
  addEventListener('keydown', e=>{ if (e.code==='KeyP') pauseBtn.click(); if (e.code==='KeyR') resetBtn.click(); });

  // ----- Modal & leaderboard -----
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `
    <div class="panel">
      <h2 id="modalTitle">Run Over</h2>
      <div class="grid">
        <div>
          <div id="summary"></div>
          <div class="scores">
            <strong>Leaderboard</strong>
            <ol id="boardList"></ol>
          </div>
          <div class="tip">Tip: Install the app and play offline. Matching pallet & rack colour gives a 1.5× bonus.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:.5rem">
          <button class="btn" id="againBtn">Play Again</button>
          <button class="btn" id="shareBtn">Share</button>
          <button class="btn" id="dismissBtn">Close</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(modal);
  function renderBoard(){
    const list=$('#boardList'); list.innerHTML='';
    getBoard().forEach((e,i)=>{ const li=document.createElement('li'); li.textContent = `${e.score} pts — ${fmtTime(e.time)}`; list.appendChild(li); });
  }
  function openModal(){ modal.style.display='flex'; renderBoard(); }
  function closeModal(){ modal.style.display='none'; }
  $('#dismissBtn').onclick=closeModal;
  $('#againBtn').onclick=()=>{ reset(); pauseBtn.textContent='Pause'; };
  $('#shareBtn').onclick=async()=>{
    const text=`Forklift Runner — ${scoreV.textContent} pts in ${timeV.textContent}!`;
    if (navigator.share) { try{ await navigator.share({text, title:'Forklift Runner'});}catch{} } else { navigator.clipboard.writeText(text).then(()=>showToast('Copied to clipboard')); }
  }

  function endRun(){
    world.running=false; world.gameOver=true;
    const score=world.score, time=world.time; const name='You';
    pushBoard(name,score,time);
    $('#modalTitle').textContent='Run Over';
    $('#summary').innerHTML=`<div class="pill" style="display:inline-block;margin-bottom:.5rem">Score: <b>${score}</b> • Time: <b>${fmtTime(time)}</b> • Loads: <b>${world.loads}</b></div>`;
    openModal();
  }

  // Start
  reset(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>